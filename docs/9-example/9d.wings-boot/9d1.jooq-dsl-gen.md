---
isOriginal: true
icon: note
category:
  - 实战
  - 手册
---

# 9D1.Jooq最佳实操

WingsBoot体系内对Jooq进行了简化，在实践中有以下约定和语法糖

## 9D1.1.代码生成

推荐使用`Warlock3JooqGenerator`，其进一步封装了`WingsCodeGenerator`，

* databaseIncludes - 基于正则，指定生成代码的表
* setGlobalSuffix - 可对全局对象增加后缀，以区分同包不同工程
* forcedStrCodeEnum - 绑定varchar和enum类型
* forcedIntConsEnum - 绑定int和emum类型
* forcedLocale - 绑定varchar和Locale类型
* forcedZoneId -  绑定int和ZoneId类型
* forcedZoneStr -  绑定varchar和ZoneId类型

```java
Warlock3JooqGenerator generator = new Warlock3JooqGenerator();
generator.setTargetDir(JAVA);
generator.gen(JDBC, USER, PASS,
        Warlock3JooqGenerator.includeWarlock(),
        bd -> bd.setGlobalSuffix("Warlock"));
```

默认配置中，对以下类型做了映射

* Boolean - `TINYINT(\(1\))?`，所有字段
* Integer - `TINYINT[2-9()]*`，所有字段
* Locale - 字段`.*\.locale`，所有类型
* ZoneId - 字段`*\.zoneid`，类型`INT.*`和`(VAR)?CHAR.*`

## 9D1.2.Dao和Dsl

Jooq官方示例中，都采用了静态引入Table，注入Dsl的形式，但在wings中推荐从Dao入手。

```java
// 以lombok完成Setter注入，必须setter注入
@Setter(onMethod_ = {@Autowired})
private WinConfRuntimeDao dao;
```

```java
// 检查表是否存在
dao.notTableExist()
// 通过Dao获取Table和Dsl
WinConfRuntimeTable a = dao.getAlias();
WinConfRuntimeTable t = dao.getTable();
DSLContext dsl = dao.ctx();
```

WingsJooqDaoAliasImpl和WingsJooqDaoJournalImpl中存在大量方法

* batchXX - 批量插入，合并，更新等操作有关
* fetchXX - 按类型或自动读取数据
* countXX - count记录数
* insertXX - 插入有关
* updateXX - 更新有关
* deleteXX - 逻辑或物理删除

Dsl和Dao等价，都在service层以下使用。

* 简单操作用Dao，复杂的用Dsl
* Dao更像java，Dsl更像Sql
* 当有条件和字段时，两者都要明确table或alias
* Dsl可以getSql，也可用Any2Dto把Sql变为Dsl

## 9D1.3.精确查找

用什么就获取什么，用pojo或record接收，确保强类型。

```java
final WinUserLoginTable t = winUserLoginDao.getTable();
// Dao 
dao.fetch(t, 0, 2, t.Id.gt(1L).and(t.CommitId.lt(200L)),
    t.Id, t.CommitId,
    t.Id.desc());
// Dao lambda
dao.fetch(0, 2, t -> SelectOrderCondition.of(
                t.Id.gt(1L).and(t.CommitId.lt(200L)),
                t.Id, t.CommitId,
                t.Id.desc()));
// Dsl
winUserLoginDao
    .ctx()
    .select(t.AuthType, t.LoginIp, t.LoginDt, t.Terminal, t.Failed)
    .from(t)
    .orderBy(t.LoginDt.desc())
    .limit(query.toOffset(), query.getSize())
    .fetch()
    .into(Item.class);
```

## 9D1.4.精确更新

```java
final WinUserBasisTable tu = winUserBasisDao.getTable();
// Dao map
Map<Field<?>, Object> setter = new HashMap<>();
setter.put(tu.Nickname, user.getNickname());
setter.put(tu.CommitId, commit.getCommitId());
winUserBasisDao.update(tu, setter, tu.Id.eq(userId), true);
// Dao pojo
WinUserBasisTable upo = new WinUserBasisTable();
upo.setNickname(user.getNickname());
upo.setCommitId(commit.getCommitId());
winUserBasisDao.update(tu, upo, tu.Id.eq(userId), true);

// Dsl
winPermEntryDao
    .ctx()
    .update(tu)
    .set(tu.CommitId, commit.getCommitId())
    .set(tu.ModifyDt, commit.getCommitDt())
    .set(tu.Remark, remark)
    .where(tu.Id.eq(permId))
    .execute();
```
